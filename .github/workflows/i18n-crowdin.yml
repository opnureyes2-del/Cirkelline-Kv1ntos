# Crowdin i18n Sync Workflow
# Automatically syncs translations with Crowdin

name: i18n Crowdin Sync

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'locales/**'
      - 'cirkelline-ui/messages/**'
      - 'crowdin.yml'
  pull_request:
    paths:
      - 'locales/**'
      - 'cirkelline-ui/messages/**'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'upload'
        type: choice
        options:
          - upload
          - download
          - both

env:
  CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
  CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}

jobs:
  # Upload source strings to Crowdin
  upload-sources:
    name: Upload Sources to Crowdin
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'upload' || github.event.inputs.action == 'both'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate source files
        run: |
          echo "Validating JSON translation files..."
          for file in locales/da/messages.json cirkelline-ui/messages/da.json; do
            if [ -f "$file" ]; then
              python3 -c "import json; json.load(open('$file'))" && echo "âœ“ $file is valid JSON"
            fi
          done

      - name: Upload to Crowdin
        uses: crowdin/github-action@v1
        with:
          upload_sources: true
          upload_translations: false
          crowdin_branch_name: ${{ github.ref_name }}
          config: crowdin.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload status
        run: |
          echo "âœ“ Source strings uploaded to Crowdin"
          echo "Branch: ${{ github.ref_name }}"

  # Download translations from Crowdin
  download-translations:
    name: Download Translations from Crowdin
    runs-on: ubuntu-latest
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || (github.event_name == 'workflow_dispatch' && (github.event.inputs.action == 'download' || github.event.inputs.action == 'both'))

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download from Crowdin
        uses: crowdin/github-action@v1
        with:
          upload_sources: false
          upload_translations: false
          download_translations: true
          localization_branch_name: i18n-crowdin-sync
          create_pull_request: true
          pull_request_title: 'chore(i18n): sync translations from Crowdin'
          pull_request_body: |
            This PR syncs translations from Crowdin.

            ## Changes
            - Updated translations for supported languages

            ## Checklist
            - [ ] Review translation changes
            - [ ] Run i18n tests
            - [ ] Verify RTL layout for Arabic

            ---
            ðŸ¤– Generated automatically by Crowdin GitHub Action
          pull_request_labels: 'i18n,automated'
          config: crowdin.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Validate translations
  validate-translations:
    name: Validate Translations
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install pytest

      - name: Validate JSON files
        run: |
          echo "Validating all locale JSON files..."
          for lang in da en sv de ar; do
            backend_file="locales/$lang/messages.json"
            frontend_file="cirkelline-ui/messages/$lang.json"

            if [ -f "$backend_file" ]; then
              python3 -c "import json; json.load(open('$backend_file'))" && echo "âœ“ $backend_file"
            fi

            if [ -f "$frontend_file" ]; then
              python3 -c "import json; json.load(open('$frontend_file'))" && echo "âœ“ $frontend_file"
            fi
          done

      - name: Check key consistency
        run: |
          echo "Checking key consistency across locales..."
          python3 << 'EOF'
          import json
          import sys
          from pathlib import Path

          errors = []

          # Check backend locales
          da_file = Path("locales/da/messages.json")
          if da_file.exists():
              with open(da_file) as f:
                  da_keys = set(json.load(f).keys())

              for lang in ["en", "sv", "de", "ar"]:
                  lang_file = Path(f"locales/{lang}/messages.json")
                  if lang_file.exists():
                      with open(lang_file) as f:
                          lang_keys = set(json.load(f).keys())

                      missing = da_keys - lang_keys
                      extra = lang_keys - da_keys

                      if missing:
                          errors.append(f"{lang}: Missing keys: {missing}")
                      if extra:
                          print(f"Warning: {lang} has extra keys: {extra}")

          if errors:
              print("Errors found:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          else:
              print("âœ“ All locales have consistent keys")
          EOF

      - name: Run i18n tests
        run: |
          cd /home/rasmus/Desktop/projects/cirkelline-system
          PYTHONPATH=. pytest tests/test_i18n*.py -v --tb=short
