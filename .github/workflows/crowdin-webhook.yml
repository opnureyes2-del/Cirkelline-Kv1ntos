name: Crowdin Webhook Handler

# Triggered by Crowdin webhooks via repository_dispatch
# Automatically downloads translations and creates PRs when
# translations are updated or files reach 100% completion

on:
  repository_dispatch:
    types:
      - crowdin_translation_updated  # Any translation update
      - crowdin_file_ready           # File 100% translated

permissions:
  contents: write
  pull-requests: write

jobs:
  handle-webhook:
    runs-on: ubuntu-latest
    name: Process Crowdin webhook

    steps:
      - name: Log webhook event details
        run: |
          echo "==================================="
          echo "Crowdin Webhook Event"
          echo "==================================="
          echo "Event Type: ${{ github.event.action }}"
          echo "Project: ${{ github.event.client_payload.project }}"
          echo "Language: ${{ github.event.client_payload.language }}"
          echo "File: ${{ github.event.client_payload.file }}"
          echo "Branch: ${{ github.event.client_payload.branch }}"
          echo "Timestamp: $(date)"
          echo "==================================="

      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download translations from Crowdin
        uses: crowdin/github-action@v2
        with:
          upload_sources: false
          upload_translations: false
          download_translations: true
          crowdin_branch_name: ${{ github.event.client_payload.branch || 'main' }}
          config: crowdin.yml
          create_pull_request: false  # We'll create PR manually for better control
        env:
          CROWDIN_PROJECT_ID: ${{ secrets.CROWDIN_PROJECT_ID }}
          CROWDIN_PERSONAL_TOKEN: ${{ secrets.CROWDIN_PERSONAL_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status -s) ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status -s
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No translation changes detected"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: l10n_${{ github.event.client_payload.language }}_${{ github.run_number }}
          delete-branch: true
          title: 'i18n: Update ${{ github.event.client_payload.language }} - ${{ github.event.client_payload.file }}'
          body: |
            ## Translation Update (Webhook Triggered)

            **Language:** ${{ github.event.client_payload.language }}
            **File:** ${{ github.event.client_payload.file }}
            **Branch:** ${{ github.event.client_payload.branch }}
            **Triggered:** Webhook event at ${{ github.event.client_payload.timestamp }}

            ### Review Checklist
            - [ ] Translation quality verified
            - [ ] Placeholders checked (e.g., `{field}`, `{min}`, `{max}`)
            - [ ] UI tested in application

            ### Special Considerations

            ${{ github.event.client_payload.language == 'ar' && '⚠️ **Arabic (RTL)**: Test right-to-left layout' || '' }}
            ${{ github.event.client_payload.language == 'de' && '⚠️ **German**: Check text length (may be +30% longer)' || '' }}

            **Auto-generated by Crowdin webhook**
          labels: |
            i18n
            translations
            ${{ github.event.client_payload.language }}
            webhook-triggered
          reviewers: rasmus
          assignees: rasmus
          commit-message: 'i18n: update ${{ github.event.client_payload.language }} translations [ci skip]'

      - name: Comment on PR (if Arabic)
        if: |
          steps.changes.outputs.changed == 'true' &&
          github.event.client_payload.language == 'ar'
        uses: peter-evans/create-or-update-comment@v3
        with:
          issue-number: ${{ steps.create-pr.outputs.pull-request-number }}
          body: |
            ### RTL Testing Required

            This PR updates Arabic (RTL) translations. Please verify:

            1. **Text Direction**: Ensure `dir="rtl"` is set correctly
            2. **UI Mirroring**: Check that layout elements are mirrored
            3. **Numerals**: Verify Western numerals (123) are used, not Arabic (١٢٣)
            4. **Bidirectional Content**: Test mixed LTR/RTL content (URLs, emails, brand names)
            5. **Typography**: Confirm no bold or italic formatting

            **Testing URL**: `http://localhost:3000?lang=ar`

      - name: Log completion
        run: |
          if [[ "${{ steps.changes.outputs.changed }}" == "true" ]]; then
            echo "✓ Pull request created successfully"
          else
            echo "✓ No changes to commit"
          fi
